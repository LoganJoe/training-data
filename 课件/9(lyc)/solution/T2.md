[TOC]

##### 题目大意

给定一棵树，多次询问从一个点移动到另一个点在最优策略下的期望步数。你有两种移动方式：沿着一条边，从一端走到另一端，花费一步；在所有点中均匀随机地选择一个点，移动到那里，花费一步。

误差不超过 $\epsilon = 10^{-6}$，$n \le 10^5$，$q \le 2 \times 10^5$。时限 4 sec。

##### 思路

注意到第一种移动方式是一种确定的移动方式，而第二种移动方式移动的结果与当前位置无关，于是我们发现从起点到终点的方法只有可能是这样的：一开始以第二种移动方式移动 $x$ 次，然后以第一种移动方式移动 $dis$ 次。因此我们可以注意到一个点到另一个点的期望步数只与两点间的距离有关，与两点的位置无关。

感性理解下，当我们离终点比较远时，我们肯定是选择随机移动比较优的，否则我们应该直接走向终点。那么我们的最优策略就应该是这样的：若当前点到终点的距离大于阈值 $threshold$，就选择随机跳跃，否则选择直接走。

设从某个点出发到终点的期望步数为 $E(x)$。设有 $num$ 个点到终点的距离小于等于 $threshold$，设它们到终点的距离之和为 $sum$。对于这 $num$ 个点来说，显然 $E(x) = dis$；对于剩下的点来说，显然它们的期望步数相等，有：
$$
E(x) = \left( \frac {num} {n} \cdot \frac {sum} {num} + \frac {n - num} {n} E(x) \right) + 1
$$

$$
E(x) = \frac {sum + n} {num}
$$

考虑 $threshold$ 的变化对起点的 $E(x)$ 有什么影响。当 $threshold \ge dis(u, v)$ 时，答案为 $threshold$，否则答案为 $\frac {sum + n} {num}$。注意到 $\frac {sum} {num}$ 是在阈值范围内的点到终点距离的平均值，也就是是说随着阈值的减少该值在不断减少；由于 $num$ 随着阈值减少而减少，因此 $\frac {n} {num}$ 随着阈值减少在增加，故可二分。

注意到 $threshold$ 的取值只有设为某个点到终点的距离才是有用的，因此二分的时间复杂度为 $O(\log n)$。总时间复杂度为 $O(n \log^3 n)$。

##### 总结

这道题首先要注意到答案不是在模意义下给出的，然后注意到那个阈值，基本上就做出来了。