# B. Mysterious … Host 题解

### 题意

**定义 1** 排列 $p$ 的一个区间是**连续段**当且仅当两个区间内的数之间的所有数都在区间内。

**定义 2** 两个排列等价当且仅当他们同阶且连续段集合相同。

求 $n$ 阶排列的等价类个数。

### 算法

**引理 1** 两个交集非空的连续段的并和交都是连续段。

显然成立。

有了这个引理，我们可以发现两个交集非空且互不包含的区间可以被它们的交和并描述。我们重点关注拿些不能如此的区间。

**定义 3** 一个连续段是**本原连续段**当且仅当不存在一个和它互不包含且交集非空的连续段。

考虑本原连续段之间的关系。由定义，显然存在一棵唯一的有根有序森林使得每个本原连续段对应一棵子树。并且：

**引理 2** $[i,i]$ 和 $[1,n]$ 是本原连续段。

显然成立。

于是这个森林形成一棵树，根对应 $[1,n]$ 且叶子分别对应 $[i,i]$。

在此基础上，我们考虑那些非本原连续段。我们可以发现：

**引理 3** 每个非本原连续段必然可以表示为一段连续的本原连续段兄弟之并。

显然成立。

并且：

**引理 4** 对于一组极大的本原连续段兄弟（即某个本原连续段的所有孩子），它们中大于 $1$ 且小于总数个组成的每一段要么都是非本原连续段，要么都不是连续段。

**证** 

> 即得易见平凡，仿照上例显然，留作习题答案略，读者自证不难。
>
> 反之亦然同理，推论自然成立，略去过程Q.E.D.，由上可知证毕。

于是，可以将本原连续段分为两类，称孩子之间至少形成一个非本原连续段的为**正本原连续段**，否则为**异本原连续段**。

于是，每个 $n$ 阶排列 $p$ 唯一地对应于一棵具有 $n$ 个节点且每个节点被分为以上两种类型的有根有序树 $p$，且 $p$ 和连续段集合一一对应。

于是答案即为合法树的个数。我们考虑对于一棵树如何构造：对于一个异本原连续段，它的儿子数不能为 $1$ 和 $3$；对于一个正本原连续段，它的儿子数至少为 $3$。只要满足这个条件，一定可以构造。

不过这个看起来有点奇怪，我们把儿子数很少的情况稍作调整。设 $B$ 类节点为儿子数不少于 $4$ 的异本原连续段子树的根；$A$ 类节点为其余情况。这样条件就变成了 $B$ 的儿子个数不小于 $4$ 且 $A$ 的儿子个数不小于 $2$ 或为 $0$。

于是递推即可，复杂度 $O(n^2)​$。

设 $A,B$ 和答案关于子树大小的普通型生成函数为 $F,G,H$（常数项为 $0$），那么：
$$
\begin{cases}
H=F+G\\
F=\sum_{i=2}^\infty H^i\\
G=x+\sum_{i=4}^\infty H^i\\
\end{cases}
$$
化简得：
$$
\begin{cases}
H=F+G\\
F=\frac{H^2}{1-H}\\
G=x+\frac{H^4}{1-H}\\
\end{cases}
$$

代入：
$$
\begin{align}
H(1-H) & = H^2+x(1-H)+H^4 \\
H^4+2H^2-(x+1)H+x & = 0
\end{align}
$$

牛顿迭代式：
$$
H(x)\gets H(x)-\frac{H^4+2H^2-(x+1)H+x}{4H^3+4H-(x+1)}
$$

如此复杂度为 $O(n\log n)$。