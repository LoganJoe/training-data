---
title: " DTOJ4237能量\t\t"
tags:
  - 奇技淫巧
  - 数学
url: 7098.html
id: 7098
categories:
  - Solution
date: 2019-03-24 11:27:23
---

注意到这里$a$可能为负，而$k$不一定是偶数。那么我们就要对值域区间分段考虑： - 当$k$为奇数时，需要考虑的范围是$(-\\infty, a\],(a,+\\infty)$。前半段的贡献是$a^k$，后半段的贡献是$x^k$。 - 当$k$为奇数时，需要考虑的范围是$(-\\infty,-|a|\],(-|a|,|a|\],(|a|,+\\infty)$。仅有中间一段的贡献是$a^k$，两头的贡献均为$x^k$。 下面考虑计算$\\sum{x\_i}$恰好落在某一区间内的概率。首先假设所有变量在$\[0,+\\infty)$内均匀随机。 考虑记 $p\_n(s)$ 表示 $n$ 个随机变量之和不超过 $s$ 的概率密度函数。注意这里的概率密度函数并非指的是其真正的概率，而是当$x \\to x\_0$ 时$x$服从的概率分布。概率密度函数满足对于一个取值在区间$\[a,b\]$上的均匀分布函数$I\_{\[a,b\]}$，它的概率密度函数：$f_{i_{\[a,b\]}}(x)=\\frac{1}{b-a}I_{\[a,b\]}$。 考虑枚举最后一个变量的取值，那么 $$ p\_n(s)=\\int\_{0}^{s}p_{n-1}(x)\\mathrm{dx} $$ 又有$\\forall s,p\_0(s)=1$，所以 $$ p\_n(x)=\\frac{x^n}{n!} $$ 考虑 $n$ 个随机变量的和恰好等于 $x$ 的概率 $q\_n(x)$。对于已经知道$n-1$个变量和不超过$x$的概率$p\_{n-1}(x)$，我们考虑其任意取值$s$，我们都可以令第$n$个变量取值为$x-s$使得$n$个变量和为$x$。于是： $$ q\_n(x)=p\_{n-1}(x)=\\frac{x^{n-1}}{(n-1)!} $$ 考虑处理单个变量$\[l,r\]​$的限制。我们可以处理某个变量$\\ge l\_i​$和$\\ge r\_i​$两种限制。后者肯定是不合法的。考虑容斥。我们强制令某个集合$S​$内的数均不合法，然后乘上容斥系数计算贡献。具体地，我们令$x\_i=s\_i+ \\Delta\_i​$，其中，$\\Delta\_i \\in\[0,\\infty)​$。那么这样就强制限制了$x\_i​$大于某个数的限制。此时我们对于每个数，分别令$s\_i=l\_i​$和$s\_i =r\_i​$。那么当前要求的，对于$\[l,r\]​$区间贡献即是 $$ \\int\_{l}^{r}q\_n(x-\\sum s\_i) \\max\\{x^k,a^k\\}\\mathrm{dx} $$ 此时，就一定有$x-\\sum s\_i \\in\[0,+\\infty\]$了。 那么考虑前面的两类区间：首先考虑$k​$为奇数的情况，我们要分别计算 $$ \\int\_{a}^{\\infty}q\_n(x-\\sum s\_i)x^k\\mathrm{dx} $$ $$ \\int_{-\\infty}^{a}q\_n(x-\\sum s\_i)a^k\\mathrm{dx} $$ 对于第二个算式，我们相当于直接计算 $$ \\begin{aligned} &a^k\\int_{-\\infty}^{a}q\_n(x-\\sum s\_i)\\mathrm{dx}\\\ =&a^k\\int_{-\\infty}^{a}\\frac{(x-\\sum{s\_i})^{n-1}}{(n-1)!} \\mathrm{dx}\\\ =&\\frac{a^k}{(n-1)!}\\int\_{-\\infty}^{a-\\sum s\_i}x^{n-1} \\mathrm{dx}\\\ =&\\frac{a^k}{(n-1)!}\\frac{(a-\\sum\_{s\_i})^n}{n} \\\ =&\\frac{a^k(a-s)^n}{n!} \\end{aligned} $$ 回过头来考虑第一个，要计算 $$ \\int\_{\\sum_{s\_i}}^{a}q\_n(x-\\sum s\_i)x^k\\mathrm{dx} $$ 考虑分别计算$\\int q\_n(x-\\sum_{s\_i})x^k \\mathrm{dx}$在$\\sum{s\_i},a$两处的值。 求$x=\\sum s\_i x=a$ $$ \\begin{aligned} &\\int q\_n(x-\\sum{s\_i})x^k \\mathrm{dx}\\\ =&\\int \\frac{(x-\\sum\_{s\_i})^{n-1}}{(n-1)!}x^k\\mathrm{dx}\\\ =&\\frac{(x-\\sum s\_i)^nx^{k+1}}{(k+1)\\times n!} + C\\\ =&\\frac{1}{(k+1)(n-1)!}\\sum_{i=0}^{n-1}\\frac{1}{i-1}(-1)^i\\binom{n-1}{i}x^i(\\sum s\_i)^{n-i}x^{k+1} \\end{aligned} $$ 对于偶数的处理也是类似的。其中需要注意在处理$(-\\infty,-|a|)$的时候要将区间翻回到正区间计算，这样才能保证$q\_n(x)$的前提条件成立。 但是每次枚举集合$S$的效率太慢了。注意到每次的贡献仅仅和$\\sum s\_i$有关，那么我们可以预处理出$f(S)$表示$S=\\sum{s\_i}$的=对应容斥系数，即其最终会被答案计算几次。这个可以用一个背包dp解决：考虑当前$len=r\_i-l\_i$,那么$\\sum s\_i=sum\_l+j+len$的系数即为 $$ f\[j + len\] = (f\[j + len\] - f\[j\]) $$ 先背包预处理即可。