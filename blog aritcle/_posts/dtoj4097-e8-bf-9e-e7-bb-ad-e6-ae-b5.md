---
title: " DTOJ4097连续段\t\t"
tags:
  - dp
  - 奇技淫巧
  - 生成函数
url: 6012.html
id: 6012
categories:
  - Solution
date: 2019-01-13 14:34:05
---

对于一个排列的连续段，我们可以用极差来判断。那么考虑连续段所具有的性质。

既然其包含的数在数轴上面都是连续的。那么两个有交连续段的并和交均是连续段。这个很容易想到，因为本身对应的数的区间就是有交的。

下面定义： 一个连续段是**本原连续段**，当且仅当不存在一个和它互不包含且交集非空的连续段。

考虑这样的一个连续段。因为没有子连续段，我们可以将其当做最基本的单元来看待。假设还有包含它的连续段，将其关系建出来，其就是树形结构。

那么肯定，$\[1,1\]$与$\[1,n\]$是本原连续段。于是建出树形关系，$\[i,i\]$肯定就是所有的叶子节点。这样，我们将这个问题丢在树上考虑。这样所有的非本原连续段就可以用若干个本原连续段表示了。

下面考虑一个引理：

对于一组极大的本原连续段兄弟（即某个本原连续段的所有孩子），它们中大于 $1$ 且小于总数个组成的每一段要么都是非本原连续段，要么都不是连续段。

这个引理在题解中出题人也没有给出证明。但是仔细感受一下还是可以发现它是对的。

于是，问题转化为构造树的方案数。每个 $n$ 阶排列 唯一地对应于一棵具有 $n$ 个节点且每个节点被分为以上两种类型的有根有序树$p$ ，且 $p$ 和连续段集合一一对应。于是答案即为合法树的个数。 将本原连续段分为两类，称孩子之间至少形成一个非本原连续段的为**正本原连续段**，否则为**异本原连续段**。 我们考虑对于一棵树如何构造：对于一个异本原连续段，它的儿子数不能为 $1$ 和 $3$ ；对于一个正本原连续段，它的儿子数至少为 $3$ 。只要满足这个条件，一定可以构造。

将节点分为两种。$B$类节点为儿子数不小于 $4$ 的异本原连续子段的根，$A$类节点为Otherwise。这样我们就可以通过$A$$B$两种取值来递推了。

但是丧心病狂的$LCA$将这题的数据加强到$1e5$。考虑组合技术类问题的母函数法。

设 $A,B$ 和答案关于子树大小的普通型生成函数为 $F,G,H$（常数项为 $0$），那么：  
$$  
\\begin{cases}  
H=F+G\  
F=\\sum_{i=2}^\\infty H^i\  
G=x+\\sum_{i=4}^\\infty H^i\  
\\end{cases}  
$$  
化简得：  
$$  
\\begin{cases}  
H=F+G\  
F=\\frac{H^2}{1-H}\  
G=x+\\frac{H^4}{1-H}\  
\\end{cases}  
$$

代入：  
$$  
\\begin{align}  
H(1-H) & = H^2+x(1-H)+H^4 \  
H^4+2H^2-(x+1)H+x & = 0  
\\end{align}  
$$

按照下列方法行牛顿迭代：  
$$  
H(x)\\gets H(x)-\\frac{H^4+2H^2-(x+1)H+x}{4H^3+4H-(x+1)}  
$$

这样复杂度就降到 $O(n\\log n)$了。