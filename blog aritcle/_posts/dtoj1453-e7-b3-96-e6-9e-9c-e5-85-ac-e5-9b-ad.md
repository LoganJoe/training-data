---
title: " DTOJ1453糖果公园\t\t"
tags:
  - 莫队
url: 1124.html
id: 1124
categories:
  - DTOJ
  - Solution
date: 2018-03-20 19:41:29
---

维护这种次数不同贡献还不同的奇怪东西，一般也只有莫队能写了（雾 也可能是我见识短浅。那么就是树上莫队了。 但这题还有修改。那么就是待修改的树上莫队了… 带修改的莫队主要就是块的大小变成了$n^{\\frac{2}{3}}$（可以用库里的pow函数算），排序的关键字变化了，然后要模拟时间的流逝和回溯。 首先先dfs一遍将树分块，也就是子树大小超过块的大小就切。 然后对于询问，设$x$的dfs序小于$y$的dfs序。然后以$x$所在块的编号为第一关键字，$y$所在块的编号为第二关键字，当前询问之前的修改次数为第三关键字排序。 排完序之后，我们不仅要维护当前的答案，还要记下当前已经处理的修改个数。对于一个询问，如果当前已经处理的修改数小于询问之间发生的修改数，那么就要处理未处理的修改，否则就要撤销之前的修改，也就是时间的回溯，撤销修改可以通过记录修改之前的数是多少来实现。 处理完修改后，就是树上莫队的套路了。假设当前维护的答案是路径$(x,y)$（不含$lca$），询问是路径$(a,b)$，那么将路径$(x,a)(y,b)$（不含$lca$）上的点出现状态取反并计算贡献，再加上$lca(a,b)$就是询问的答案了。