---
title: " DTOJ4078generals\t\t"
tags:
  - 倍增
  - 思路
url: 5904.html
id: 5904
categories:
  - Solution
date: 2019-01-01 10:30:19
---

博弈题就是分讨好题。只不过这题有点小胖。 首先考虑两人在两点之间路径上走是否相遇。很明显当两人不相遇时答案为$k \\mod 2$。这个时候考虑$k>dist(a,b)$，即两人相遇的情况。记$d=dist(a,b)$。

*   $k \\mod 2 =1,d \\mod 2 = 1$。相遇后后手先手，之后先手一定要追着后手走，使得答案一直为$2$。
*   $k \\mod 2 =0,d \\mod 2= 1$。类比于上面的case，但是最后一步要让后手再走一步，所以答案为$0$。
*   $k \\mod 2 =0,d \\mod 2 = 0$。这个时候由于相遇的时候是先手走，后手每一步都跟着先手走，将答案控制为$-1$。
*   $k \\mod 2 =1,d \\mod 2 = 0$。类比于上面的case，最后一步是先手走，答案为$1$。

这个时候两人一定是会在$(a,b)$之间的道路上相向而行的。但是其实，这两个人是可以溜的，也就是进入子树以后开始头也不回的狂奔。在这里，我们一定要让这个得出的答案比上面的答案更优。 注意观察上面的四个case，当$k \\mod 2 =0,d \\mod 2= 1$和$k \\mod 2 =1,d \\mod 2 = 0$的时候，假设我们朝着一个方向溜，也并不会使得答案更优。其实它是转换到了一个$k \\leq dist(a,b)$的情况，并不能给到更多的贡献。 而考虑$k,b$同奇偶的两种情况。假设劣势手开始往自己的子树里面狂奔，当另外一方追不上自己的时候，就可以使得答案更优。否则答案一定会更劣，并且劣出天际。 下面特殊考虑$k>dist(a,b),k \\mod 2 \\equiv d \\mod 2$的case。 要让优势手追不上自己，实际上就是要找一条不经过对方$\\lceil \\frac k2 \\rceil$，范围内的，长度$\\ge \\lceil \\frac k2 \\rceil$的路径。我们在$(a,b)$路径上讨论在哪个地方劣势手朝着子树里面走。

*   $x$往上一段未到lca。考虑维护一条链上向下走长度的最大值。可以预处理出每个点向下走的最长链和次长链对应的叶子节点的深度，然后用树上倍增维护$f(x)-2deep\[x\]$的最大值，这样就可以用树上倍增方便的维护这个值了。注意在前面处理次长链的意义在于所求的最长链不能对于这条路径往回走，假设起始点就在最长链上面就要走次长链。
*   考虑从$lca$开始溜。一种是往上面走，那么我们从lca开始向上面倍增，用上面同样的方法即可解决。还有的就是在lca往下走，这个很不好处理。因为从lca开始向下两条链都有可能不能选。因此我们这里还需要处理出次次长链的值。
*   lca开始往对方的方向向下走。同样也是要处理从某个地方向下拐的最大值，这个地方的处理和上面的类似。

当$lca=a/b$的时候需要特判。