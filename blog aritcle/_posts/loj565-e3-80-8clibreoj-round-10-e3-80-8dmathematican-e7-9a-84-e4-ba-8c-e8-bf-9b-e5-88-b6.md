---
title: " LOJ565「LibreOJ Round #10」mathematican 的二进制\t\t"
tags:
  - NTT
  - 期望
  - 概率
  - 生成函数
url: 6423.html
id: 6423
categories:
  - Solution
date: 2019-02-08 14:06:56
---

注意到，每次操作后的代价不好计算。因为我们需要排除进位的影响。 但是其实，我们可以抛开操作顺序。因为操作顺序对于代码没有影响。实际上，最终代价仅与哪些数被执行过有关。每次进位会让1的个数减少1。那么总代价其实是**所有被执行的操作的总次数的两倍减去最终剩下的数中 $1$ 的个数。** 那么我们逐位计算贡献：$f(i,j)$表示从后往前第$i$位被改变$j$次的概率：

*   进位，$f(i-1,j) \\to f(i,\\lfloor\\frac{j}{2}\\rfloor)$
*   某位加，$f(i,j-1)\\times p+f(i,j)(i-p)\\to f(i,j)$

那么这个可以$O(m^2)$计算。 这个东西实际上是可以用分治NTT优化的。逐位考虑贡献，那么每一位的生成函数是$f(x)=\\prod (px+1-p)$。而前面进位的贡献也是一个奇位卷积。用分治$NTT$优化即可。 具体地，假设余进位的$f$的生成函数为$G(x)$，上一位的生成函数为$f'(x)$，显然有$\[x^k\]G(x)=\[x^{2k}\]f'(x)+\[x^{2k+1}\]f'(x)$。那么$f(x)G(x)$的奇数次项就是剩下的贡献了。 注意到，会有进位产生。所以要一直做到$G(x)=0$为止。