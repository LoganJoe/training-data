---
title: " DTOJ2711线段树\t\t"
tags:
  - 倍增
  - 可持久化线段树
  - 线段树
url: 2229.html
id: 2229
categories:
  - DTOJ
  - Solution
date: 2018-06-06 17:58:36
---

我们发现，进行编号为$\[L,R\]$的操作之后，如果$k \\in\[l\_R,r\_R\]$，那么$a\_k$的值就是进行了编号为$\[L,R-1\]$的操作后，$\[l\_R,r\_R\]$的最大值；否则就是进行了编号为$\[L,R-1\]$的操作后，$a\_k$的值。 这样我们就可以将询问$\[L,R\]$变成询问$\[L,R-1\]$。同样地，如果要求进行$\[L,R-1\]$的操作后$\[a,b\]$的最大值，我们也可以变成求进行$\[L,R-2\]$的操作后的问题。只要判断最后一次操作区间有没有包含$a,b$两个端点即可。然后最终一次询问就会变成询问一段区间的最大值了。 那么如何求出最后的查询区间呢？ 注意到查询区间的端点一定是操作区间的端点，那么我们只用求出两个端点分别属于哪个操作即可。 假设我们可以求出对于每个操作的左/右端点，在这个操作之前最后一个包含它的操作是哪一个。然后通过倍增预处理后，我们就可以知道每个操作的左/右端点，在这个操作之前倒数第$2^k$个包含它的操作是哪一个。那么对于询问进行$\[L,R\]$操作后$a\_k$的值，我们只需要求出$\[L,R\]$内的操作最后一个包含$k$的操作是哪一个，就可以通过倍增求出$a\_k$的值是最初哪段区间的最大值。 那么现在的问题就是，如何求出某段操作中最后一次包含某个位置的操作是哪个。假设我们要求$\[l,r\]$的操作中最后一次包含位置$x$的操作是哪个。我们可以将问题转换成，$\[1,r\]$的操作中，最后一个包含位置$x$的操作是哪个。如果找到的操作编号$<l$，就说明$\[l,r\]$的操作中没有一个操作包含位置$x$。 我们只要按顺序覆盖$\[1,r\]$中每个操作的区间，就可以知道每个位置最后被包含的操作是哪个了。 区间覆盖很容易用线段树完成，但此题要对于每个$r$都覆盖一次$\[1,r\]$的操作的区间，因此用主席树完成即可。并且要同时开棵线段树维护区间最大值。 写的特别乱…尴尬。