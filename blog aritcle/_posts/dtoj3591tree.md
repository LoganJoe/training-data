---
title: " DTOJ3591tree\t\t"
tags:
  - 树形dp
  - 线段树合并
url: 1336.html
id: 1336
categories:
  - DTOJ
  - Solution
date: 2018-04-06 21:05:51
---

设$f\[i\]\[j\]$为以$i$为根的子树内，保证选的点点权$\\leqslant j$，最多能选的点数。 对应的转移有两种：

*   不选点$i$，那么就把$i$的所有儿子对应的$f\[son\]\[j\]$加起来。
*   选点$i$，那么对于$j\\geqslant val\_i$，有$f\[i\]\[j\]=max(f\[i\]\[j\],f\[i\]\[val\_i-1\]+1)$。

那么选点$i$就相当于从$f\[i\]\[val\_i\]$开始区间$+1$，当然也有可能不加。 令$g\[i\]\[j\]=f\[\[i\]\[j\]-f\[i\]\[j-1\]$。那么在$f$上区间$+1$就相当于在$g$上单点加$+1$。而区间$+1$的范围就是从$val\_i$开始的一段$g$都为$0$的区间。因此在$g\[i\]\[val_i\]$上$+1$，在之后第一个不为$0$的$g\[i\]\[j\]$上$-1$即可。 那我们可以对每一个点开一棵线段树，每次转移就把子树的线段树合并起来，然后单点修改两个位置。找修改的位置可以通过查询一段区间的$g$的和是否为$0$来判断是否要继续向右找。