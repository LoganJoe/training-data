---
title: " DTOJ3913svisor\t\t"
tags:
  - 动态点分治
  - 树形dp
  - 虚树
url: 3847.html
id: 3847
categories:
  - DTOJ
  - Solution
date: 2018-09-08 15:09:06
---

我们考虑暴力。 记$f\[i\]$表示从点$i$会监视到$i$向下多远的点，初始肯定有$f\[a\_i\]=r\_i$。 然后一个$f\[x\]$可以更新$x$的父亲和儿子的$f$，我们用两遍dfs即可求出所有点的$f\[i\]$，这实际上是树上的一个最短路。 通过$f\[i\]$即可知道总共有多少点被监视了。 考虑正解。 每次给定$k$个点，且保证了$\\sum k\\leq 5\\times 10^5$。这种情况一般都要建虚树。 我们建树虚树后，照样可以求出虚树上每个点的$f\[i\]$，注意这时$f\[i\]$定义中的距离是指原树的。 记$cnt(x,i)$表示原树上距离$a\_i\\leq i$的点数，我们可以$\\Theta(n\\log n)$求出点分树，然后每次可以$\\Theta(\\log n)$查询。 可以想到答案一定和$\\sum\_{x}cnt(x,f\[x\])$有关。但是我们要减去虚树上某些边会算重的影响。 即如果虚树上有一条$x$到$y$的边，且$f\[x\]+f\[y\]\\geq dist(x,y)$，那么$cnt(x,f\[x\])$和$cnt(y,f\[y\])$一定会算重。$dist(x,y)$是原树上$x$到$y$的距离。 考虑扣掉重复的点数。 我们在原树中$x$到$y$的路径上找到一个位置$z$，使得满足$f\[x\]-dist(x,z)=f\[y\]-dist(z,y)$，记$d=r\_x-dist(x,z)$，那么我们可以发现重复算的点数就是$cnt(z,d)$，只要减去$cnt(z,d)$即可。 如果$z$在树边上就有点麻烦，我们可以在一开始的时候就把原树的每条边拆成两条长度为$0.5$的边，即在每条边的中间加一个虚拟点。这样找到的$z$就一定在点上了。 那么答案就是$\\sum\_x cnt(x,f\[x\])-\\sum_{x,y}cnt(z,d)$。 如果用倍增求LCA的话，时间复杂度是$\\Theta((n+\\sum k)\\log n+n\\log^2 n)$。 如果用欧拉序求LCA的话，时间复杂度是$\\Theta((n+\\sum k)\\log n)$。