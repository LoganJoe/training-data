---
title: " DTOJ3967计数\t\t"
tags:
  - 树形dp
url: 4750.html
id: 4750
categories:
  - Solution
date: 2018-10-29 14:17:48
---

由于前序遍历与编号相同，而前序遍历即dfs序中一个子树中的编号连续。所以对于一个子树，其子树内的编号是连续的。

考虑dp计算方案数。

$f\[i\]\[j\]$为第$i$个点为根的子树，子树内最大编号是$i+j$的方案数。由于一定是编号小的做编号大的子树的父亲，考虑倒着更新。

对于题目“$u\_i$在$v\_i$之前”的限制，我们可以将其用二维前缀和表示。对于限制相当于在$A\[u\_i\]\[v\_i\]$处$+1$。对$A\[\]\[\]$做二位前缀和，那么要查询是否有$\[a,b\]$内任一编号比$\[c,d\]$小的限制，那么就是在查询$A\[a...b\]\[c...d\]$内是否有值。

我们就可以在$O(1)$内查询是否有限制了。

我们枚举当前根编号$i$，再枚举左子树最大编号$j$，右子树最大编号$k$，其中有$i<j<k$，做如下转移：

$$ f\[i\]\[k-i\] \\Leftarrow f\[i+1\]\[j-i-1\] \\times f\[j+1\]\[k-j-1\]$$

这个转移的限制在于不存在$i>j, \ i>\[i+1,j\], \ \[j+1,k\]>i, \ \[i,j\]>\[j+1,k\]$的限制。

另外还有左/右子树为空：

*   左右均为空，仅有$f\[i\]\[0\]=1$
*   左边为空，不存在$i>\[i+1,j\]$，有：$f\[i\]\[j-i\] \\Leftarrow f\[i+1\]\[j-i-1\]$。
*   右边为空，不存在$\[i+1,j\]<i$，有：$f\[i\]\[j-i\] \\Leftarrow f\[i+1\]\[j-i-1\]$。

效率是$O(n^3)$的。