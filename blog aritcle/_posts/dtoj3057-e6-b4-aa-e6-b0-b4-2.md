---
title: " DTOJ3057洪水\t\t"
tags:
  - 动态dp
  - 树链剖分
  - 线段树
url: 5758.html
id: 5758
categories:
  - Solution
date: 2018-12-23 15:59:14
---

动态dp...? 首先考虑答案。在无修改的情况下，很容易列出下列的树形dp方程：设$f\[x\]$为$x$为根子树的答案。 $$f\[x\]=\\min\\set {w\[x\],\\sum f\[son\] }$$ 接下来考虑每一次修改对于答案的影响。显然，每次修改只会影响该点到根之间的dp值。 注意到每个点的$w\[x\]$只会增加。可以知道的是，$f\[x\]$也是单调不减的。当当前点$\\sum f\[son\] <w\[x\]+v$的时候显然是不会影响答案的。否则考虑$f\[x\]$的增量$\\Delta$。下面记$g\[x\]=\\sum f\[son\]$。 考虑其到根路径上一点$y$。假设有$g\[y\]+\\Delta \\leq w\[y\]$，那么这个点一定会被更新，具体$f\[y\]+=\\Delta,g\[y\]+=Delta$。这样更新直至第一个$g\[y\]+Delta > w\[y\]$的点位置$z$，此时有$f\[z\]=w\[z\],g\[z\]+=\\Delta$。 那么注意到此时，对于$f\[z\]$由产生了一个新的$\\Delta$。这时的问题变得和修改的点一样了。同样的，对于$\\Delta=0$我们不用做，否则按照上面得步骤向上更新即可。 考虑优化更新。容易想到树链剖分。 在线段树上维护$w\[x\]-g\[x\]$。那么树链剖分的时候在线段树上二分就可以找到第一个不满足的位置了。否则就是整段的区间加。这个时候也可以顺带维护出$f\[x\]$。