---
title: " DTOJ4297Rozstaw szyn\t\t"
tags:
  - 树形dp
url: 4181.html
id: 4181
categories:
  - Solution
date: 2018-10-17 23:05:32
---

首先让我们了解一下以下引理的正确性：

1.  一个顶点的子树达到最优，当且仅当是在它的儿子达到最优的情况下。
    *   这个不难想到。因为对于父亲的变动带来的增减一定会比变动儿子来的更小或者相同。
2.  每个点都有一个区间，在这个区间内取权值对于答案的影响相同。
    *   容易看出，因为对于其儿子，权值改变会使得某部分的差减小，某部分的差增大。而在一段区间内这个是可以互相抵消的。
3.  一个树达到最优的条件是其所有子树达到最优。
    *   这个可以由 1 推得。
4.  对于已经确定的每个儿子的取值范围，我们可以确定该点的权值的取值范围。
    *   首先证明存在性。既然可以通过3推出传递性，而2成立的原因又是由于儿子推出的，那么一定会存在一段区间，使得在儿子最优的情况下使得该点最优。
    *   由于2可得，该点的权值区间满足其中每个权值“比其权值小的区间数量等于比其权值大的区间数量”才能相互抵消，从而使得区间内权值相同。

由上述部分我们可以得到接下来叙述算法的正确性。

为了找到这个区间，我们可以将子节点的所有区间左右端点拿出来排序，然后取中间两个数作为两端点。下证这个一定满足引理，进而满足最优。

我们可以将所有区间分成三类：

*   右端点比当前点的区间小的
*   左端点比当前区间大的
*   跨过或包含当前区间的

其中，跨过与包含的情况对于答案没有贡献。那么要前两种区间的数量相等。

而跨过的区间端点分立两侧，另外的区间只会对一边的贡献加$2$，所以当我们这样构造区间时一定是满足条件的。并且可以发现这个是范围最大的区间。

按照上述过程就可以算出最后的答案了。