---
title: " DTOJ4139白白的\t\t"
tags:
  - 平衡树
  - 树套树
  - 线段树
url: 6570.html
id: 6570
categories:
  - DTOJ
  - Solution
date: 2019-02-23 20:59:19
---

发现只有将位置变黑的操作，而没有变白的操作。 那么每次变黑操作可能会讲一个极长的白区间分裂成两个极长的白区间。 我们只要快速求出分裂后的两个极长的白区间的逆序对数，就可以更新答案了。同时我们还要快速支持修改。 逆序对是一个二维偏序，强制在线还要支持修改，只能用树套树了。 外层线段树或者树状数组以区间下标为关键字，内层为值域线段树，这样就可以每次$\\Theta(\\log ^2 n)$求出每个位置上的数产生的逆序对数，也就是可以$\\Theta(\\log ^2 n)$完成修改操作。 现在考虑变黑操作。 如果我们每次分裂后，枚举一遍短的区间，时间复杂度其实是$\\Theta(n\\log n)$的。因为分裂可以看成合并的逆过程，而这就是启发式合并的逆过程。 那么我们容易想到，每次分裂的时候，枚举短的区间，然后在树套树上查询即可求出短区间的逆序对数。而长区间的逆序对数可以用原来的逆序对数减去短区间对逆序对的贡献数。 但是发现这样是$\\Theta(n\\log ^3 n)$的，凉凉了。 考虑换一种更优秀的做法。 我们对于每个极长的白区间，开一棵值域平衡树，然后分裂时，一边往新平衡树里加点，一边在上面查询短区间产生的逆序对数，以及一边在原平衡树上删点，一边查询短区间的数对原来逆序对数的贡献。 这样每次查询，加点，删点都是$\\Theta(\\log n)$的，总时间复杂度是$\\Theta(n\\log ^2 n)$的。 其实线段树也可以完成，但是可能空间开不下。 总时间复杂度$\\Theta((n+q)\\log ^2 n)$。 输入要开long long！巨坑。