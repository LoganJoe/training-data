---
title: " DTOJ1875三叉神经树\t\t"
tags:
  - 树链剖分
  - 线段树
url: 3580.html
id: 3580
categories:
  - DTOJ
  - Solution
date: 2018-08-26 11:50:01
---

先考虑点$x$从$0$变成$1$之后，会发生什么。 如果$fa\_x$除$x$外的两个儿子都是$0$或者都是$1$，那么不会发生任何变化。 只有当$fa\_x$除$x$外的两个儿子中有一个$1$的时候，$fa\_x$会从$0$变成$1$。 而$fa\_x$从$0$变成$1$，对$fa_{fa\_x}$的影响也是同理。 我们记点$x$的儿子中，值为$1$的数量为$cnt\_x$。 我们发现，$x$从$0$变成$1$之后，会将$x$往上一段原来$cnt=1$的点，全部从$0$变成$1$。 同理，$x$从$1$变成$0$之后，会将$x$往上一段原来$cnt=2$的点，全部从$1$变成$0$。 那么我们就是要维护每个点的$cnt$，以及找到从某个点往上$cnt$为$1$或$2$的极长段。 考虑树链剖分，这样一个点往上到根的路径就变成了一段段区间。 然后我们按照树剖序建线段树，维护每个点的$cnt$。具体地，对于线段树上每个结点，我们维护这段区间的点$cnt$的最大值和最小值，这样在查询的时候我们就能快速知道某个区间的点的$cnt$是否全部相同了。 每次修改时，我们从$x$往上不断跳重链，同时在线段树上二分找到第一个$cnt\\neq 1$或$cnt\\neq 2$的点，然后给对应的区间集体$+1$或者$-1$即可。