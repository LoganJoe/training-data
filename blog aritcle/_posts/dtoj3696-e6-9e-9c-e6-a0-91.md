---
title: " DTOJ3696果树\t\t"
tags:
  - 线段树
url: 1928.html
id: 1928
categories:
  - DTOJ
  - Solution
date: 2018-05-10 16:11:59
---

要求一条路径上面不能出现同颜色的点，也就是很多组限制形如$a\_i,b\_i$不能一起出现在路径上，问有多少条合法的路径。 假如路径$(u,v)$不合法，也就是说路径上同时出现了一组$a\_i,b\_i$。

如果$a\_i$是$b\_i$的祖先。设$p$是$a\_i$到$b\_i$的路径上一点，且$p$的父亲为$a\_i$。那么$u$和$v$两个点，一个不在$p$的子树内，另一个在$b\_i$的子树内。 如果$a\_i$和$b\_i$谁也不是谁的祖先。那么$u$和$v$两个点，一个在$a\_i$的子树内，另一个在 $b\_i$的子树内。 接下来是一个巧妙的变换。 我们把$(u,v)$映射到二维平面上的一个点，横坐标是$u$的DFS序，纵坐标是$v$的DFS序，那么，一组限制让平面上的一个矩形（$a\_i$和$b\_i$谁也不是谁的祖先）或两个矩形（$a\_i$是$b\_i$的祖先）内的所有点代表的路径都不合法了。 那么问题转换成了：有一个$n×n$的二维平面，上面有一些矩形。求有多少个格子，不在任何一个矩形内部。 由于同一颜色出现次数不超过$20$次，因此限制有最多$20n$组，矩形最多只有$40n$个。 可以用线段树+扫描线在$\\Theta(40nlog\\space n)$内解决。