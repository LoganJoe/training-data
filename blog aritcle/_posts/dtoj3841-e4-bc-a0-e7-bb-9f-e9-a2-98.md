---
title: " DTOJ3841传统题\t\t"
tags:
  - 奇技淫巧
  - 数学
url: 3036.html
id: 3036
categories:
  - DTOJ
  - Solution
date: 2018-07-25 14:17:39
---

zzq的神仙数学题……暴力和正解毫无关系。 显然我们只关心最长连续相同子段的长度，而序列中的数字是多少是无关的。 考虑最长连续相同子段的长度为$x$的方案数有$f\[x\]$种，那么对答案有$x\\times f\[x\]$的贡献。 考虑最长连续相同子段的长度$\\geqslant x$的方案数有$g\[x\]$种，那么答案就是$\\sum_{i=1}^{n}g\[i\]$。因为一个$f\[x\]$会在$1\\sim x$被$g\[i\]$计算一次。 然后暴力就是dp求出f或者g。 对于正解，我们考虑推式子。 记最长连续相同子段长度$\\leqslant x$的方案数有$F\[x\]$种，显然有$F\[x\]=m^n-g\[x+1\]$，那么答案就是 $$ \\sum_{i=1}^{n}(m^n-F\[i-1\]) $$ 我们考虑算 $$ \\sum_{i=0}^{n-1}F\[i\] $$ 枚举分成了$j$段，那么答案就是 $$ \\sum_{i=0}^{n-1}\\sum_{j=1}^{n}m(m-1)^{j-1}\\times (j个\\leqslant i的变量且和为n的方案数) $$ 每个变量相当于每段的长度。 如果没有$\\leqslant i$的限制，那么是就是简单的隔板法。 有限制之后，我们可以想到容斥，枚举有$k$个$>i$的变量，那么答案就变成了 $$ \\sum_{i=0}^{n-1}\\sum_{j=1}^{n}m(m-1)^{j-1}\\sum_{k=0}^{j}(-1)^k \\binom{j}{k}\\binom{n-ik-1}{j-1} $$ 我们把$m$和$k$往外提，那么有 $$ m\\sum_{i=0}^{n}\\sum_{k=0}^{n}(-1)^{k}\\sum_{j=k}^{n}(m-1)^{j-1}\\binom{j}{k}\\binom{n-ik-1}{j-1} $$ 最后的组合数有个$-1$，zzq说看它很不爽，那么我们把$-1$提出来，有 $$ m\\sum_{i=0}^{n}\\sum_{k=0}^{n}(-1)^{k}\\frac{1}{n-ik}\\sum_{j=k}^{n}j(m-1)^{j-1}\\binom{j}{k}\\binom{n-ik}{j} $$ 注意到由于组合数的实际意义，我们有$j\\leqslant n-ik$，又有$j\\geqslant k$，那么就有$ik+k\\leqslant n$。那么枚举$i$和$k$就是调和级数的效率，现在只用把$j$消掉即可。 考虑对于最后一个sigma找出一个组合意义： 我们有$n-ik$个球，先选出$j$个，再从$j$个里面选出$k$个。在$j$个球中选出一个特殊的球，并对剩下$j-1$个球用$m-1$种颜色染色。 我们可以讨论这个特殊的球是不是在选出来的$k$个球中，那么就变成： 我们有$n-ik$个球，先选出$k$个，然后有两种情况：

*   在$k$个球中选出一个特殊的，把剩下$k-1$个球用$m-1$种颜色染色。然后在剩下$n-ik-k$个球中选出若干个球（也可以不选），也用$m-1$种颜色染色。
*   把$k$个球用$m-1$种颜色染色，在剩下的$n-ik-k$个球中选出一个特殊的。然后在剩下的$n-ik-k-1$中选出若干个球（也可以不选）用$m-1$种颜色染色。

考虑每一步的方案数。

*   在$k$个球中选出一个特殊的，把剩下$k-1$个球用$m-1$种颜色染色：$$k(m-1)^{k-1}$$在剩下$n-ik-k$个球中选出若干个球（也可以不选），也用$m-1$种颜色染色。相当于用$m$种颜色染色，第$m$种颜色表示不选：$$m^{n-ik-k}$$

*   把$k$个球用$m-1$种颜色染色，在剩下的$n-ik-k$个球中选出一个特殊的：$$(n-ik-k)(m-1)^k$$在剩下的$n-ik-k-1$中选出若干个球（也可以不选）用$m-1$种颜色染色。和上面一样，相当于用$m$种颜色染色：$$m^{n-ik-k-1}$$

那么我们就有 $$ \\sum_{j=k}^{n}j(m-1)^{j-1}\\binom{j}{k}\\binom{n-ik}{j}=k(m-1)^{k-1}m^{n-ik-k}+(n-ik-k)(m-1)^km^{n-ik-k-1} $$ 只要预处理出$m-1$和$m$的次幂这个式子就可以$\\Theta(1)$算了，是不是很神奇！ 那么时间复杂度就是枚举$i$和$k$，为$\\Theta(n\\log n)$。 要注意$k=0$或者$n-ik-k=0$的情况。