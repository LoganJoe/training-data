---
title: " DTOJ3036区间\t\t"
tags:
  - 思路
  - 线段树
url: 2941.html
id: 2941
categories:
  - DTOJ
  - Solution
date: 2018-07-22 12:17:51
---

经历了看对题开始写，写着写着就看错题了…还好主体都不用改，否则气死… 数字区间$\[l,r\]$能被拼出，相当于$\[l,r\]$中的数在$P$中形成了连续一段或者两段。 先考虑暴力的写法。 我们枚举左端点$l$，且从小到大枚举右端点$r$，然后维护连续的段数。记右端点移动后新加进来的数在$P$中的位置是$x$。 如果位置$x-1$和位置$x+1$的数都在$\[l,r\]$中，那么段数$-1$。如果都不在，段数$+1$。如果一个在而另一个不在，段数不变。 当段数为$1/2$时，$\[l,r\]$就能被拼出。 这样是$\\Theta(n^2)$的。我们考虑优化一下。 考虑从小到大枚举右端点$r$，那么我们要维护对于每一个左端点$l$，数字区间$\[l,r\]$在$P$中的段数，记为$f\[l\]\[r\]$。 考虑递推，当右端点为$r$时，我们已知所有的$f\[l\]\[r-1\]$。记$r$在$P$中的位置是$x$。 我们考虑位置$x-1$和位置$x+1$上的数。记$Max=\\max(P_{x-1},P_{x+1}),Min=\\min(P_{x-1},P_{x+1})$。

*   如果$P_{x-1}>r$且$P_{x+1}>r$，$r$就是单独的一段，那么有 $$ f\[l\]\[r\]=f\[l\]\[r-1\]+1,l\\in\[1,r\] $$
*   如果$Min<r$且$Max>r$，那么有 $$ f\[l\]\[r\]= \\begin{cases} f\[l\]\[r-1\] & l\\in\[1,Min\] \\newline f\[l\]\[r-1\]+1 & l\\in(Min,r\] \\newline \\end{cases} $$

*   如果$P_{x-1}<r$且$P_{x+1}<r$，那么有 $$ f\[l\]\[r\]= \\begin{cases} f\[l\]\[r-1\]-1 & l\\in \[1,Min\] \\newline f\[l\]\[r-1\] & l\\in(Min,Max\] \\newline f\[l\]\[r-1\]+1 & l\\in (Max.r\] \\newline \\end{cases} $$

发现都是区间加/减的操作，很容易用线段树维护。 能够维护$f$后，我们还需要统计有多少个$f\[l\]\[r\]$的值为$1$或$2$。 这个同样可以用线段树维护，在每个结点上维护区间最小值，最小值个数，区间次小值和次小值个数即可。 线段树的pushup挺复杂的，要注意细节。