---
title: " Codeforces916E Jamie and Tree\t\t"
tags:
  - 倍增
  - 思路
  - 线段树
url: 5200.html
id: 5200
categories:
  - DTOJ
  - Solution
date: 2018-11-21 20:58:23
---

### 题意

一棵$n$个点的树，每个点有初始点权$a_i$。 要求支持换根、对$u,v$的$LCA$子树加和查询每个点的子树权值和。

### 题解

一看到换根，直接上LCT。 LCT是肯定可以写的，但是过于复杂。 这里讲较为简单的做法。以下讲的$LCA$/父亲之类的与树相关的东西，都是指以$1$为根的树。 记当前的根为$rt$。我们把所有子树问题都通过dfs序变成序列上的问题，记第$i$个点的子树在dfs序上的区间为$\[L\_i,R\_i\]$。 我们得处理换根后每个点子树里的点的变化。即找到换根后子树里的点在dfs序上对应的区间，这样才能修改和查询。 每次修改，我们先求出$u$和$v$的$LCA$。 我们考虑$LCA$和$rt$的相对位置关系。

*   $rt$在$u$到$v$的链上，直接在$\[1,n\]$上区间加即可。
*   $rt$在$LCA$的子树外，那么直接在$\[L_{LCA},R_{LCA}\]$上区间加即可。
*   否则我们求出$rt$往上跳，直到所处的点的父亲在$u$到$v$的链上，记这个点为$x$。那么我们在$\[1,n\]$上区间加，然后扣掉对$\[L\_x,R\_x\]$的贡献即可。

再考虑查询。同样考虑$x$和$rt$的相对位置关系。

*   $x=rt$，答案就是$\[1,n\]$区间和。
*   $rt$在$x$的子树外，答案是$\[L\_x,R\_x\]$的区间和。
*   否则我们求出$rt$往上跳，直到所处的点的父亲为$x$，记这个点为$y$。那么答案就是$\[1,n\]$的区间和减去$\[L\_y,R\_y\]$的区间和。

画画图就很显然了。 往上跳的过程要用倍增实现。 时间复杂度$\\Theta(n\\log n)$。