---
title: " DTOJ4075冒泡排序\t\t"
tags:
  - 思路
  - 线段树合并
url: 5692.html
id: 5692
categories:
  - Solution
date: 2018-12-21 17:24:30
---

对于冒泡排序，其swap数实际上就是逆序对的数量。而逆序对，即是要求在其前面比它大的数的数量。这个东西可以加到线段树上面维护。 依次考虑所有的操作怎么维护。我们对于每个序列，开一棵权值线段树，维护其上面的值。

*   对于加入一个数的操作，相当于新开一棵权值线段树，然后将这个数插入到对应位置。
*   对于两个序列的合并操作，考虑对应维护信息的线段树的合并。考虑用线段树合并维护。其中合并的时候，我们还要维护答案，就是要计算两个序列之间的贡献，用另外一棵树前面的去更新当前后面的。只要在合并的时候顺带记录一下前缀和就好了。
*   对于序列的倍长，由于每个子段都是相同的。首先对于原来序列的内部答案要计算进去，那么我们要考虑前面序列对于后面的贡献。先考虑复制一遍的情况，记原序列中某个值$i$出现了$cnt\[i\]$次，那么其代价就是$\\frac 12 \\sum_{i \\neq j} cnt\[i\]cnt\[j\]=\\frac 12 (\\sum cnt\[i\])^2+ \\sum cnt\[i\]^2$。而考虑$k$倍就是前面对于后面分别做一次贡献，乘上$\\frac{k(k-1)}{2}$就对了。那么直接考虑在线段树上一并维护$cnt\[i\]$与$cnt\[i\]^2$的区间和，而倍长以后多了一个区间乘的操作，$cnt\[i\]$与$cnt\[i\]^2$要分别乘上$k$与$k^2$。

出题人坑爹，$n \\le 6 \\times 10^6$