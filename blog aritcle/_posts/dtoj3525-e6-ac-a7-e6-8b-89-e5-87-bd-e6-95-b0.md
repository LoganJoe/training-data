---
title: " DTOJ3525欧拉函数\t\t"
tags:
  - CDQ分治
url: 602.html
id: 602
categories:
  - DTOJ
  - Solution
date: 2018-02-16 20:08:47
---

先考虑加法的查询。 发现所有的数总和最大到2e9，先筛出2e9内的质数，O(log)区间求和后质因数分解计算$φ$。 现在考虑乘法的查询。 乘积显然很大，但质因数分解后最大只有4e4。且有

$φ(x)=x\\prod_{i}(1-\\frac{1}{p\_i})=x\\prod\_{i}\\frac{p\_i-1}{p\_i}$

因此我们要维护区间乘积，和区间$\\frac{p\_i-1}{p\_i}$的乘积。 前者可以用树状数组维护，现在考虑后者。 假设质因子$p$出现在位置$x\_1,x\_2,…,x\_k$，那么如果将询问区间$\[l,r\]$看作一个点$(l,r)$，则若$(l,r)$右下方包含某个$(x\_i,x\_i)$的点，就说明这段区间有质因子$p$。 因此在每个$(x\_i,x\_i)$打上$\\frac{p-1}{p}$的标记，$(x\_{i-1},x_i)$打上$\\frac{p}{p-1}$的标记。质因子$p$对询问$\[l,r\]$的贡献就是$(l,r)$右下方所有点标记的乘积。 因此初始时将数列的数质因数分解插入标记。修改时我们要将原标记删掉，等价于添加一个原标记的逆元。然后将修改后的数质因数分解加入新的标记。某个质因子在数列中出现的位置可以用set维护。 动态加点并查询，这是一个三维偏序问题，用CDQ分治+树状数组即可。