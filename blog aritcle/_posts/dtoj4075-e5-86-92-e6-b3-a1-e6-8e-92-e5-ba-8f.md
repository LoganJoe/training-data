---
title: " DTOJ4075冒泡排序\t\t"
tags:
  - 思路
  - 线段树合并
url: 5564.html
id: 5564
categories:
  - DTOJ
  - Solution
date: 2018-12-16 16:04:54
---

菜鸡出题人居然把冒泡排序写错了。 等等等等看一下这场模拟赛的时间？啥七月份？！ 出题人居然压到了NOI的题目！并且和NOI一样写错了冒泡排序？不过错的方式好像不同。 我好像发现了什么不得了的事情（大雾） 以下开始正题。 冒泡序列的交换次数就是逆序对个数。 我们考虑如何形象地表示出原来的序列。 考虑一棵二叉树，每个点代表栈中的一个元素。叶子节点为我们加入的数。每个点有一个点权，代表这个点被重复了多少次。 指针指到一个正的$a\_i$，就新建一个叶子节点。 指到一个$0$，就把最后两个点合并，并且新建一个点作为它们的父亲。 指到一个负的$a\_i$，就给对应的点权乘上倍数。 我们先序遍历这棵二叉树，每遍历完一棵子树，就把子树对应的序列复制点权倍，然后接在当前序列的后面。遍历完一整棵树就得到了原序列。 当然我们不可能把整个序列求出来。我们考虑如何在树上算贡献。 考虑两个叶子节点带来的贡献。 假设两个叶子节点上的数分别为$a,b$，$a$被复制了$cnt\_1$次，$b$被复制了$cnt\_2$次。从根节点到$LCA(a,b)$经过的点的点权的乘积为$v$。 我们可以分情况讨论。

*   $a\\leq b$。那么前$cnt\_2$个$b$后面有$cnt\_1\\times (v-1)$个$a$，第二组$cnt\_2$个$b$后面有$cnt\_1\\times (v-2)$个$a$……如此下去，逆序对$(b,a)$共有$cnt\_1\\times cnt\_2\\times \\frac{v(v-1)}2$。
*   $a>b$。那么前$cnt\_2$个$b$后面有$cnt\_1\\times v$个$a$，第二组$cnt\_2$个$b$后面有$cnt\_1\\times (v-1)$个$a$……如此下去，逆序对$(b,a)$共有$cnt\_1\\times cnt\_2\\times \\frac{v(v+1)}2$。

我们考虑在$LCA$处计算出子树内所有逆序对的贡献。 逆序对的贡献和每种数字的出现次数有关。因此我们对每个点开一棵线段树，维护子树内每种数字出现的次数。 我们dfs一遍，回溯的时候线段树合并，即可维护子树内每种数字出现的次数。 贡献在线段树合并的时候一起计算即可。 注意回溯的同时要给线段树里所有数字的出现次数乘上点权。 因此线段树上还要维护一个乘法标记。 测试时线段树合并被我写TLE了，我也很绝望啊。