---
title: " DTOJ2983Prefix\t\t"
tags:
  - hash
  - 可持久化线段树
url: 5604.html
id: 5604
categories:
  - DTOJ
  - Solution
date: 2018-12-16 23:20:11
---

虽然强制在线，但我们不妨考虑一下如果可以离线我们咋写。 我们从左到右维护区间右端点$r$，用线段树维护左端点在对应位置时区间不同的前缀的数量。 当右端点向右移动一位时，会新出现一些前缀。对于新出现的某个前缀，假如它上一次出现的位置为$p$，那么使会使左端点在$\[p+1,r+1\]$的不同前缀数量$+1$。我们将前缀hash起来，维护每种前缀最后出现的位置，然后在线段树上区间加即可。 强制在线的话，我们就不能一边枚举右端点一边回答询问了。但我们还是可以知道每个前缀上一次出现的位置。 也就是说我们要保留右端点在每个位置时的线段树。这也就是将线段树可持久化，那么我们将线段树改成主席树。 由于主席树上区间加较为复杂（因为pushdown要新开结点），我们可以将区间加变成差分，然后变成询问区间和。 从右往左的差分比较好些。当然写主席树区间加也行。 时间复杂度$\\Theta(N\\log N)$。