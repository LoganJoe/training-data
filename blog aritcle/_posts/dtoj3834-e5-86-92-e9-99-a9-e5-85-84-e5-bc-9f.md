---
title: " DTOJ3834冒险兄弟\t\t"
tags:
  - 凸包
  - 思路
  - 环加外向树
url: 2963.html
id: 2963
categories:
  - DTOJ
  - Solution
date: 2018-07-22 14:01:25
---

对于一件装备，我们在$x\_i$和$y\_i+n$连一条双向边。 那么题意就变成了，一条边要匹配一个点，然后每种匹配有对应的权值，要让$\\sum a\\sum b$最小。 显然连通块之间是独立的，我们可以对每个连通块分别考虑。 如果一个连通块里的边数$>$点数的话，一定不存在合法的方案。而题目保证了有解，因此边数只有可能是点数或点数$-1$。也就是说，一个连通块要么是树，要么是环加外向树。

*   假如连通块是树的话，一定会有一个点没被匹配，我们可以枚举哪个点没被匹配，那么剩下的点匹配哪条边是固定的，因此一共有点数种不同的匹配方案。我们可以通过两遍dfs很容易地求出每种匹配方案的$\\sum a$和$\\sum b$。
*   假如连通块是环加外向树的话，如果环的匹配确定了，那么外向树的匹配也固定了。而环的匹配只有两种（顺时针或者逆时针），所以总的匹配方案也只有两种。通过几遍dfs也可以求出两种匹配方案的$\\sum a$和$\\sum b$。

那么现在问题变成了，从每个连通块内选择一个匹配方案，使得总的$\\sum a\\sum b$最小。 对于每种选择方案，我们将$\\sum a$看作横坐标，$\\sum b$看作纵坐标，那么一种选择方案就对应了二维平面上的一个点。 显然最优的选择方案一定在下凸壳上。 因此，每个连通块被选的方案一定也在这个连通块所有匹配方案组成的点的下凸壳上。 将每个连通块下凸壳的第一个点的坐标相加，得到一个新的点，这个点一定是选择方案的下凸壳的第一个点。 对于选择方案的下凸壳的其它点，我们可以理解为是某些连通块内更换匹配方案得到的点。 我们把连通块下凸壳的边拿出来按斜率从小到大排序，从第一个点开始一个接一个，得到的就是完整的下凸壳。 扫一遍下凸壳上的点更新答案即可。