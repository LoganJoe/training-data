---
title: " JZOJ6008Sequence\t\t"
tags:
  - 奇技淫巧
  - 矩阵
url: 6106.html
id: 6106
categories:
  - Solution
date: 2019-01-22 15:30:32
---

考虑暴力dp。$f\[i\]$为考虑$l...i$字符的答案。很显然的dp转移是$f\[i\]=2f\[i-1\]-f\[pre\[i\]-1\]$。其中，$pre\[i\]$为字符$s\[i\]$之前出现的位置。 这个dp不好优化。考虑另外一种dp：$f\[i\]\[j\]$为前$i$位，以$j$结尾的不同序列个数。 $$ f\[i\]\[j\]=\\begin{cases}\\sum_{k=0}^{52}f\[i-1\]\[k\]& \\mathrm{if} \ j=s\_i \\newline f\[i-1\]\[j\] &\\mathrm{if \ } j \\not = s\_i\\end{cases} $$ 这样就不用减掉重复计算的部分了。 考虑用矩阵转移这个东西。设位置$i$的转移矩阵为$A\_i$。那么所要求的就是$\[1,0,\\dots,0\]A\_lA_{l+1},...A_{r}$。 我们对于$A\_i$求出$A\_i$的后缀积，与$A\_i^{-1}$的前缀积。考虑怎么快速维护这个东西。 首先注意到，$A$是对角线一排$1$复合上在$s\_i$这一列$1$的形式，像这样： $$ A\_i=\\left\[\\begin{matrix} 1&0&0&\\dots&1&\\dots&0 \\\ 0&1&0&\\dots&1&\\dots&0 \\\ 0&0&1&\\dots&1&\\dots&0 \\\ \\vdots&\\vdots&\\vdots&\\ddots&1&\\ddots&\\vdots\\\ 0&0&0&\\dots&1&\\dots&1 \\end{matrix}\\right\] $$ 而$A^{-1}$，类似于这样： $$ A^{-1}\_i=\\left\[\\begin{matrix} 1&0&0&\\dots&-1&\\dots&0 \\\ 0&1&0&\\dots&-1&\\dots&0 \\\ 0&0&1&\\dots&-1&\\dots&0 \\\ \\vdots&\\vdots&\\vdots&\\ddots&1&\\ddots&\\vdots\\\ 0&0&0&\\dots&-1&\\dots&1 \\end{matrix}\\right\] $$ 那么记$B\_i={}^{\[1\]}\\prod\_{k=1}^{i}A\_k, B^{-1}\_i={}^{\[-1\]}\\prod_{k=1}^{i}A^{-1}\_k$。其中，前面和后面分别是左乘与右乘。 那么答案就是$\[1,0,0,\\dots,0\]B\_rB^{-1}_{l-1}$。实际上，这样只要维护$B$的第一行就好了。$A$其余部分对于$B$的影响。 其中，当$B\_i=B\_{i-1}\\times A\_i$的的时候，我们注意到，只有$s\_i$那一列会发生变化。那么我们包里更新$s\_i$哪一行，顺带维护这一行的和就好了。 再来考虑$B^{-1}\_i=B^{-1}_{i-1}\\times A^{-1}\_i$。这相当于除了第$s\_i$列，每一列都扣掉了一个数。 我们用一个标记永久化维护影响即可。