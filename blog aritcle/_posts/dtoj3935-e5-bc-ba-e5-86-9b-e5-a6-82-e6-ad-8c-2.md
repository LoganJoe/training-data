---
title: " DTOJ3935强军如歌\t\t"
tags:
  - dp
  - 容斥
url: 4222.html
id: 4222
categories:
  - DTOJ
  - Solution
date: 2018-10-18 22:53:58
---

结束时序列$A$一定是一个非降序列，我们先考虑计算非降序列的方案数。由于答案和删数顺序有关，我们还要记下删了几个数。等价于记下非降序列的长度。 记$f\[i\]\[j\]$为前$i$个数中选出的非降序列长度为$j$的方案数。 那么显然有 $$f\[i\]\[j\]=\\sum_{k=1}^{i-1}\[A\_k\\leq A\_i\]f\[k\]\[j-1\]$$ 这是$\\Theta(n^3)$的。发现能转移的$A\_k\\leq A\_i$是一段连续的区间，通过树状数组优化可以做到$\\Theta(n^2\\log n)$。 求出$f\[i\]\[j\]$后，我们就会想，答案是不是$\\sum_{i=1}^{n}f\[n\]\[i\]\\times (n-i)!$。 （显然不是的 因为如果以任意顺序删这$n-i$个数的话，可能还没删完序列$A$就已经是非降的了。 这个时候就只能考虑容斥。 记$g\[i\]$为删到只剩$i$个数的方案数，显然答案就是$\\sum_{i=1}^{n}g\[i\]$。 那么有 $$g\[i\]=f\[n\]\[i\]\\times (n-i)! \\sum_{j=i+1}^{n}g\[j\]\\times \\frac{j!}{i!}$$ 即考虑一个删到只剩$j$个数的方案会使删到$i$个数的方案多算几次，$\\frac{j!}{i!}$实际上是$\\binom{j}{i}(i-j)!$，即从剩下$j$个数选出$i$个数留着，其他$i-j$个数以任意顺序删（都是不合法的）。 这样就可以求出答案了。