---
title: " DTOJ1161货币兑换\t\t"
tags:
  - CDQ分治
  - 斜率dp
url: 177.html
id: 177
categories:
  - DTOJ
  - Solution
date: 2018-01-08 20:28:56
---

显然对于每一天，我们如果要买要卖的最优策略一定是全买全卖。于是我们有了$n^2$的dp，令$f\[i\]$表示第$i$天最多的钱，$x\[i\]$表示用$f\[i\]$的钱在第$i$天能买的A券，$y\[i\]$表示用$f\[i\]$的钱在第$i$天能买的B券。显然有$y\[i\]=\\frac{f\[i\]\]}{A\[i\]\\times Rate\[i\]+B\[i\]}$，$x\[i\]=y\[i\]\\times Rate\[i\]$。于是我们有这样的转移$f\[i\]=max(f\[i-1\],A\[i\]\\times x\[j\]+B\[i\]\\times y\[j\])(j<i)$。所以我们对于一个$i$，要求$max(A\[i\]\\times x\[j\]+B\[i\]\\times y\[j\])(j<i)$。 这可以化成斜率的式子：$f\[i\]=A\[i\]\\times x\[j\]+B\[i\]\\times y\[j\]$，即$y\[j\]=-\\frac{A\[i\]}{B\[i\]}\\times x\[j\]+\\frac{f\[i\]}{B\[i\]}$，$B\[i\]>0$，所以若$f\[i\]$最大，就要使$\\frac{f\[i\]}{B\[i\]}$最大。即最大化一条斜率为$-\\frac{A\[i\]}{B\[i\]}$且过点$(x\[j\],y\[j\])$的直线的截距。画图后显然有当这条直线与由$(x\[j\],y\[j\])$组成的上凸壳上的某点相切时，截距最大。 因为我们要对所有的$j$，维护由$(x\[j\],y\[j\])$组成的上凸壳。 但是这道题的$x$和查询的斜率都不单调，需要用平衡树维护，但这太麻烦了。 我们有更简单的做法：CDQ分治。 对于一个分治过程$\[l,r\]$，假如我们已经使$\[l,mid\]$的点按坐标排序，$(mid,r\]$询问的直线斜率也有序，我们要用$(mid,r\]$中的直线去切$\[l,mid\]$的点更新$f$。我们可以先求出左区间的点组成的凸壳，再用右区间的直线扫一遍更新。因此我们可以初始时按照斜率排序，先递归处理$\[l,mid\]$，接着用$\[l,mid\]$更新$(mid,r\]$，再处理$(mid,r\]$，最后归并把两部分的点合起来。 这种分治方法很巧妙，未处理的区间是按照直线斜率排序，处理完的区间是按照坐标排序,巧妙使无序变得有序。 注意求凸壳要特判重点的问题，斜率也要注意无穷大和不存在。