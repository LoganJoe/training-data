---
title: " JZOJ6005数学\t\t"
tags:
  - FFT
  - 分治
  - 奇技淫巧
  - 定理
url: 6101.html
id: 6101
categories:
  - Solution
  - 不会证
  - 其他OJ
date: 2019-01-19 14:20:20
---

先考虑暴力，我们直接dp求出$F(n,k)$。 即 $$ F(i,j)=F(i-1,j)+iF(i-1,j-1) $$ 由于我们只关心$F(n,k)\\%p$，因此中间结果可以对$p$取模。 时间复杂度$\\Theta(n^2)$。 我们考虑$F(n,k)$的生成函数$G(x)$。 即 $$ G(x)=\\sum_{i=0}^{k}F(n,k)\\cdot x^i $$ $F(i,j)​$的转移相当于加上左边一位乘$i​$， 那么有 $$ G(x)=\\prod_{i=1}^{n}(ix+1) $$ 我们可以用分治FFT在$\\Theta(n\\log^2 n)$内求出$G(x)$。 我们只关心$F(n,k)$中非零位的个数，那么我们可以把$F(n,k)$反过来再求生成函数，也就是 $$ G^R(x)=\\sum_{i=0}^k F(n,k-i)\\cdot x^i $$ 那么有 $$ G^R(x)=\\prod_{i=1}^{n}(x+i) $$ 我们现在要求$\\prod_{i=1}^n(x+i)$在$\\%p$意义下有多少项非零。 不妨设$n=a\\cdot p+b(0\\leq b<p)$，那么有 $$ G^R(x)=\\left(\\prod_{i=1}^{p}(x+i)\\right )^a\\cdot \\prod_{i=1}^{b}(x+i) $$ 我们先考虑$\\prod_{i=1}^{p}(x+i)$，我们发现它在$\\%p$意义下有且仅有$p$个根：$0,1,2,…,p-1$。 由于$p$是质数，根据费马小定理，有$x^{p-1}\\equiv 1\\pmod p(0<x<p)$。 那我们考虑$x\\cdot(x^{p-1}-1)$，我们发现它在$\\%p$意义下有且仅有$p$个根：$0,1,2,…,p-1$。 所以我们可以认为$\\prod_{i=1}^{p}(x+i)$在$\\%p$意义下和$x\\cdot (x^{p-1}-1)$等价。 （出题人的题解这里说因为$\\mathbb{Z}\_p\[x\]$是唯一分解整环，所以$x\\cdot (x^{p-1}-1)$就是$\\prod\_{i=1}^{p}(x+i)$，我看不懂） 那么原式就变成了 $$ G^R(x)=x^a\\cdot(x^{p-1}-1)^a\\cdot \\prod_{i=1}^{b}(x+i) $$ $x^a$是整体位移，对非零位的个数没有影响，可以忽略。 考虑$(x^{p-1}-1)^a$，我们用二项式定理展开： $$ (x^{p-1}-1)^a=\\sum_{i=1}^ax^{(p-1)i}\\binom a i (-1)^{a-i} $$ 这个式子中每项的系数非零当前仅当$\\binom{a}{i}$非零。 根据Lucas定理，$\\binom a i$非零等价于$i$在$p$进制下每一位都小于等于$a$在$p$进制下的对应位。 记$a=(a\_ka\_{k-1}…a\_0)\_p$，那么非零项的个数就是$\\prod_{i=0}^k (a\_i+1)$。 我们接着考虑$\\prod\_{i=1}^{b}(x+i)$，我们分两类讨论。

*   $b<p-1$。由于$(x^{p-1}-1)^a$中非零项的次数都是$(p-1)$的倍数，所以乘上$\\prod_{i=1}^b(x+i)$后一定不会重叠。那么$G^R(x)$非零项的个数就是$(x^{p-1}-1)^a$非零项的个数乘上$\\prod_{i=1}^b(x+i)$非零项的个数。前者上文已经说过，后者直接分治FFT即可。
*   $b=p-1​$。发现$\\prod_{i=1}^{p-1}(x+i)​$和$\\prod_{i=1}^p(x+i)​$在$\\%p​$意义下是等价的，我们直接当成$(x^{p-1}-1)^{a+1}​$做即可。

时间复杂度$\\Theta(p\\log ^2 p)​$。 由于模数是$p$不是$998244353$，因此不能写NTT。 而FFT可能会被卡精度，开long double卡卡也许能卡过。 最好写任意模数NTT或者分段FFT。