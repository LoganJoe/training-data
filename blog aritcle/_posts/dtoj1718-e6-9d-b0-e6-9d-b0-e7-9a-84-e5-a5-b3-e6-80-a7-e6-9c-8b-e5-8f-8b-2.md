---
title: " DTOJ1718杰杰的女性朋友\t\t"
tags:
  - 奇技淫巧
  - 矩阵
url: 2121.html
id: 2121
categories:
  - Solution
date: 2018-05-27 20:07:38
---

同FJOI 2018 一试第三题。这里放一下那道JB题：

>  
> 
> 3.  **城市道路问题**
> 
> **(route.pas/c/cpp)** **★****问题描述****:** 小明酷爱旅行，他希望有一天能走遍祖国的所有道路。小明终于买到了祖国所有城市的详细地图。他的祖国有n个城市，且所有道路都是单向的。每个城市有p个入口和p个出口。小明可以从所在城市的任意出口出发。若小明从城市x的第i个出口出发前往城市y，则必须从城市y的第i个入口进入。从城市x的第i个入口可进入v\[x\]\[i\]条道路，从第i个出口有u\[x\]\[i\]条道路。从u\[x\]\[i\]条道路选择一条出发并从v\[y\]\[i\]条道路选择一条进入就构成了u\[x\]\[i\]* v\[y\]\[i\]条道路。 现在小明制定了m个旅行目标，第i个旅行目标的起点城市为s，终点城市为t，预定至多可走d条道路。请帮助小明确定每个旅行目标有多少种可能的旅行方案，即有多少条可行的道路。   **★****编程任务：** 对于给定的旅行目标，计算每个旅行目标有多少种可能的旅行方案。 **★****数据输入：** 输入文件名为route.in。 第一行2个整数 n和p，分别表示祖国的城市数量和出入口数。 接下来的n行中，第i行有2p个整数，前p个整数表示u\[i\]，后p个整数表示v\[i\]。 接下来一行中有一个整数m，表示小明制定的旅行方案数。 再接下来的m行中，每行有描述旅行目标的3个整数s,t,d(0 <= d < 2^31)，分别表示旅行目标的起点城市为s，终点城市为t，预定至多可走d条道路。   **★****结果输出****:** 输出文件名为route.out。 对于每个旅行目标，输出相应的可能的旅行方案数，方案数对10^9+7取模。  
> 
> **输入示例**
> 
> **输出示例**
> 
> 4 2 1 2 3 4 4 3 2 0 6 0 3 2 7 4 1 3 4 3 3 0 3 3 1 4 2 10 3 4 10
> 
> 1 19 399835395 340505076
> 
>   **★****数据范围****:** 对于40%的数据，1<=n<=50, 1<=p<=20, 1<=m<=45。 另有10%的数据，1<=n<=1000, p=1, 1<=m<=45。 所有数据满足：1<=n<=1000, 1<=p<=20, 1<=m<=50。 所有数据在int范围内。

那么我们发现，将v矩阵转置以后，$u\\times v$矩阵即是图的邻接矩阵的权值。按照这个思路做理应有40分。 然鹅我只有20分。 恶劣。 讲一下靠谱（....)的做法。 设$u$矩阵为$O$，$v$的转置矩阵为$I$ 我们先思考$u$到$v$，长度为$d$的方案数，设为$f\[d\]$。那么$(O\\times I)^d$中的$\[u,v\]$即是答案。 那么答案就是$f\[d\]=f\[0\]\*C^d=f\[0\]\*(OI^T)^d=f\[0\]\*O\*(I^TO)^{d-1}\*I$ 那么矩阵就被愉快的优化到$k\*k$的了。 但是我们要求的是不超过$d$的方案数，也就是$\\sum\\limits_{i=0}^{d} f\[i\]$。 回顾一下FJWC2018day5，有一个叫等比矩阵求和的奇技淫巧。 化一下这个答案，就是$ans=\\sum\\limits_{i=0}^{d} f\[i\]$ $$=f\[0\]+f\[0\]\*O{(I^{T}O)}^{0}I +f\[0\]\*O(I^TO)^{1}I+ \\ldots +f\[0\]\*O(I^T\*O)^{d-1}I\\\=f\[0\]\*O\*(\\sum\\limits_{i=0}^{d-1}D^{i})*I$$ 然后...没有然后了。 我觉得可以参考一下这位的题解：[julao](https://www.cnblogs.com/HocRiser/p/8453579.html)