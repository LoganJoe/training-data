---
title: " BZOJ3881[Coci2015]Divljak\t\t"
tags:
  - AC自动机
url: 5819.html
id: 5819
categories:
  - BZOJ
  - Solution
date: 2018-12-27 22:45:42
---

对集合$S$建AC自动机。 如果某个字符串包含了串$S\_x$，就说明$S\_x$的末尾结点一定是这个串某个前缀的在fail树上的祖先。 那么就有了一种想法，我们把每个前缀对应的点都抓出来，然后将每个点在fail树上到根的路径都$+1$，然后查询时就查询问串末尾结点的值。 很容易发现这样会对一个点多次$+1$。 每个点最多只能被加一次，因此我们实际上是在很多条到根的链的并上$+1$。 我们考虑把多加的减掉。 假设我们只在根到$x$和根到$y$的链的并上$+1$，实际上是在根到$x$和根到$y$的路径上$+1$，然后在根到$LCA(x,y)$的路径上$-1$。 这可以推广到多个点的情况。 我们将要加的点（每条链深度最大的点）按dfs序排序，然后在相邻点的$LCA$到根的路径上$-1$，这样就可以把多加的贡献减掉了。 我们将加一条链变成加一个点（链中深度最大的点），查询的时候由查一个点变成查子树和。 那么拿树状数组维护dfs序上的前缀和即可。