---
title: " DTOJ1811E-card\t\t"
tags:
  - 线段树
url: 3672.html
id: 3672
categories:
  - Solution
date: 2018-08-27 22:54:26
---

这是一道好题啊。

明显你要在出皇帝的地方出奴隶胜算最大吧。

考虑两个操作。一个是对于一段区间，对一个等差数列取最大值，还有就是将等差数列的某个值赋值到原数组上，然后对原数组取max。

考虑一下等差数列的优美性质。将等差数列看作一个一次函数，两个等差数列至多有一个交点，而我们要取最大的那个。那么我们用线段树维护一个区间最大的等差数列的首项与公差。这个东西你放到线段树上pushdown是$log \ n$的效率。因为只会有一个交点，所以向下至多update $O(log n)$个节点。

于是将数组下标离散化，然后对于每个节点，存左右端点的原下标$l,r$(用来计算左右端点的值），以及原数组最大值$max$，最大的等差数列的公差与首项。

至于等差数列是从$l$开始的情况，我们把所有的等差数列都看作是首项在$1$的等差数列就好了。