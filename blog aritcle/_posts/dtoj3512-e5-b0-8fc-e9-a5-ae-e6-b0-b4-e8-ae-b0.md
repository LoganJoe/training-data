---
title: " DTOJ3512小C饮水记\t\t"
tags:
  - 奇技淫巧
url: 393.html
id: 393
categories:
  - DTOJ
  - Solution
date: 2018-01-23 19:16:23
---

对于一段区间$\[l,r\]$，设$A_i$为第$i$次选的数。则最终的水量为

$\\sum_{i=1}^{r-l+1}\\frac{A_i}{2^{r-l+1-i}}$

所以肯定从小到大选最优。 发现$r-l+1-i$很大时，$\\frac{A\_i}{2^{r-l+1-i}}$对答案的影响可以忽略不计，大约当$r-l+1-i\\geqslant 30$时即可忽略。 因此一段区间只有最大的$30$个数对答案会产生影响。 分开考虑每个数对答案的贡献。 对于一个位置$i$，在$i$的左边和右边分别找$30$个最近的比$w\_i$大的数，记左边找到的为$L$，右边找到的为$R$，则$i$对答案的贡献为

$w\_i\\sum\_{x=1}^{x<30}\\sum_{y=1}^{y<30}{(L_{x-1}-L\_x})\\times (R\_y-R_{y-1})\\times {\\frac{1}{2^{x+y-1}}}$

$=2w\_i(\\sum\_{x=1}^{x<30}\\frac{L_{x-1}-L\_x}{2^x})(\\sum\_{y=1}^{y<30}\\frac{R\_y-R\_{y-1}}{2^y})$

现在的问题就是维护一个数左边比它的和右边比它大的数了。 我们可以从小到大计算每个数对答案的贡献，用链表维护左右的数，计算完后把当前数从链表删去即可。