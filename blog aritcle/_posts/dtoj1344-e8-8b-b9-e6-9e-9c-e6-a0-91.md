---
title: " DTOJ1344苹果树\t\t"
tags:
  - 莫队
url: 1120.html
id: 1120
categories:
  - DTOJ
  - Solution
date: 2018-03-20 19:13:33
---

色盲症是很好处理的，只要看两种颜色有没有都出现过即可。那么问题就变成求一段路径上出现了哪些颜色。 如果是在序列上的问题，那么显然可以用莫队解决。考虑把莫队转移到树上，也就是树上莫队。 首先要将树分块。注意不能按dfs序分块，否则可能相邻的两点会隔很远。因此要树上分块，也就是dfs过程中，如果子树大小大于块的大小，就把这些子树切掉，形成新的一块，可以用栈来实现取出子树的点。 对于询问$(x,y)$，不妨设$x$的dfs序小于$y$的dfs序，否则可以交换$x,y$。询问以$x$所在块的编号为第一关键字，$y$的dfs序为第二关键字排序。 假设显然我们已经维护好了$(x,y)$路径上的颜色，如何变成维护$(a,b)$。容易想到把$(x,a)$和$(y,b)$路径上的点的状态取反（有出现的变成没出现，没出现的变成有出现），但这样在$lca$处有一些细节的问题。一个巧妙的方法就是，先不考虑$lca(x,y)$，即$lca(x,y)$当作不在$(x,y)$的路径上，然后将$(x,a)(y,b)$取反（同样不能考虑$lca$），再将$lca(a,b)$加进去得到答案。发现这种方法完全不需要讨论细节了。