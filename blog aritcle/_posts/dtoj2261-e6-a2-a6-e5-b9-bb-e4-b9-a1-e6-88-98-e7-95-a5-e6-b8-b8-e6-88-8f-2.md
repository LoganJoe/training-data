---
title: " DTOJ2261梦幻乡战略游戏\t\t"
tags:
  - 动态点分治
url: 3938.html
id: 3938
categories:
  - DTOJ
  - Solution
date: 2018-09-15 17:00:00
---

假设我们当前选的补给站位置为$x$，那么我们把$x$抓出来当根，记$Sum\_i$为以点$i$为根的子树内所有点$d$的和。 假设$x$有一个儿子$son$，它们之间的边权为$v$，如果把补给站设在$son$更优的话，那么一定有 $$v\\times (Sum\_x-Sum_{son}-Sum_{son})<0$$ 即 $$Sum\_x<2Sum\_{son}$$ 显然满足条件的$son$最多只有一个，如果没有的话$x$就是最优解的位置。否则最优解的位置一定在以$son$为根的子树内。 那么暴力就是不断往最优的儿子走。 正解是动态点分治，我也不知道为什么可以想到用动态点分治。 我们先建出点分树。 每次询问时，我们先假设最优解位置在是点分树的根节点。 假设我们现在在点分树上以$x$为根的分治子树内求解答案，然后我们发现最优解在以$y$为根的分治子树内（$y$为$x$在点分树上的儿子，原树中有边$(x,z)$且$z$在以$v$为根的分治子树内），那么就可以转到以$y$为根的分治子树内求答案。 如果最优解没有在某个分治子树内，那么最优解位置就是$x$。 我们在点分树上维护三个值：$Sumd\_x$表示以$x$为根的子树内所有点$d$的和，$Sum1\_x$表示以$x$为根的子树内每个点的$d$与到$x$距离的乘积和，$Sum2\_x$表示以$x$为根的子树内每个点的$d$与到$fa\_x$距离的乘积和。 修改的时候，就从被修改的点往上跳，不断修改每个点的$Sumd,Sum1,Sum2$即可。 假设我们现在要计算以$x$作为补给站时的答案。 那么我们在点分树上从$x$往上跳，利用$Sumd,Sum1,Sum2$即可求出从每个点到$x$的距离与$d$的乘积和。 要利用欧拉序$\\Theta(1)$求LCA从而$\\Theta(1)$求出两点距离。