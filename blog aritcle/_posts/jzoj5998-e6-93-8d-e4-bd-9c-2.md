---
title: " JZOJ5998操作\t\t"
tags:
  - NTT
  - 分治
url: 6046.html
id: 6046
categories:
  - Solution
  - 其他OJ
date: 2019-01-16 17:09:38
---

考虑$x$经过第$i$个操作后的期望。 $x$有$P\_i$的概率变成$x+A\_i$，有$1-P\_i$的概率变成$B\_ix$。 那么$x$的期望就变成了 $$ P\_i(x+A\_i)+(1-P\_i)B\_ix $$ 即 $$ \[P\_i+(1-P\_i)B\_i\]x+P\_iA\_i $$ 我们可以把第$i$个操作看成一个形如$a\_ix+b\_i$的式子，其中$a\_i=P\_i+(1-P\_i)B\_i,b\_i=P\_iA\_i$。 那么经过第$i$个操作后的期望就是将$x$代入第$i$个式子。 我们考虑每个$b\_i$期望被算了多少次，显然是若干个$a\_i$的乘积和。 我们把除了第$i$个操作的式子变成$a\_ix+1$然后全部乘起来，得到的多项式$x^k$前的系数再$\\times k!(n-1-k)!$就是$b\_i$被算的期望次数，也就是有$k$个操作排在第$i$个操作后面时$b\_i$前的系数的期望。 那么我们就是要对于每个$i$，求出剩余$n-1$个多项式的乘积和，然后再$\\times b\_i$，最后将得到的多项式求和。 暴力乘是$\\Theta(n^2)$的，考虑优化。 我们知道，求出$n$个多项式的乘积可以用分治NTT优化到$\\Theta(n\\log ^2 n)$，那有没有办法求出缺了某个多项式的乘积和呢？ 其实仍然可以用分治NTT。 假设我们当前仅考虑区间$\[l,r\]$中的多项式，并且我们已经求出了$\[l,mid\]$和$\[mid+1,r\]$的答案和区间多项式的乘积。 那么区间$\[l,r\]$中缺的那个多项式，一定在区间$\[l,mid\]$或者区间$\[mid+1,r\]$中。 那么我们用$\[l,mid\]$中缺一项的答案乘上$\[mid+1,r\]$中多项式的乘积，加上$\[mid+1,r\]$中缺一项的答案乘$\[l,mid\]$中多项式的乘积，那就可以得到$\[l,r\]$中缺一项的答案。 用$\[l,mid\]$中多项式的乘积乘上$\[mid+1,r\]$中多项式的乘积，就可以得到$\[l,r\]$中多项式的乘积。 注意我们可以先全部DFT后，全部乘完相加再IDFT回来，这样可以减小常数。 求出$n-1$个多项式乘积和后，我们对于把第$i$项的系数$\\times i!(n-1-i)!$加起来就是答案了。 时间复杂度$\\Theta(n\\log^2 n)$。