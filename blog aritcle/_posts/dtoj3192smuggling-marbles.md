---
title: " DTOJ3192Smuggling Marbles\t\t"
tags:
  - 奇技淫巧
  - 树形dp
  - 概率
url: 5505.html
id: 5505
categories:
  - DTOJ
  - Solution
date: 2018-12-14 23:36:49
---

神题。原题为ARC086E。 计算方案数较复杂，我们改求概率。一开始我也不清楚为啥方案数就复杂了，但是对于后面的dp来讲的确是算概率比较简单。 记$f\[x\]\[i\]\[0\]$表示对于第$x$个点的子树中第$i$层的点（$x$为第$0$层），没有弹珠到第$x$个点的概率， $f\[x\]\[i\]\[1\]$表示有$1$个弹珠到第$x$个点的概率， 记$f\[x\]\[i\]\[2\]$表示至少有$2$个弹珠到第$x$个点的概率。 那么有 $$f\[x\]\[0\]\[0\]=f\[x\]\[0\]\[1\]=\\frac12,f\[x\]\[0\]\[2\]=0$$ $$f\[x\]\[i\]\[0\]=f'\[x\]\[i\]\[0\]\\times f\[son\]\[i-1\]\[0\]$$ $$f\[x\]\[i\]\[1\]=f’\[x\]\[i\]\[0\]\\times f\[son\]\[i-1\]\[1\]+f'\[x\]\[i\]\[1\]\\times f\[son\]\[i-1\]\[0\]$$ $$f\[x\]\[i\]\[2\]=1-f\[x\]\[i\]\[0\]-f\[x\]\[i\]\[1\]$$ 其中$son$为$x$的儿子，$f'\[x\]\[i\]\[0/1/2\]$是未考虑以$son$为根的子树的贡献的概率，$f\[x\]\[i\]\[0/1/2\]$是考虑完以$son$为根的概率。 更新完所有子树后，我们要令$f\[x\]\[i\]\[0\]+=f\[x\]\[i\]\[2\]$，然后令$f\[x\]\[i\]\[2\]=0$。之所以有$2$的状态是因为如果直接算在$0$的状态中，在接下来计算儿子的贡献时会被再考虑进去。 答案就是$2^n\\sum_{i}f\[1\]\[i\]\[1\]$。 这样做是$\\Theta(n^2)$的，我们考虑优化。 每个点的状态数和子树内最大深度有关。 我们求每个点的dp值就是把所有儿子的dp值合并。 那么每次我们把其他儿子的dp值往深度最大的儿子的dp值上合并。也就是说，深度最大儿子的dp值是直接“继承”过来的，我们每次只枚举到深度次大的儿子的深度来转移。 感觉就是长链剖分的思想。 时间复杂度$\\Theta(n)$。总状态数就是长链长度和，也就是$n$。也可以理解为两个状态只会在其$LCA$上合并，然后同一层两两点的$LCA$的只会有该层点数$-1$个。 具体实现可以用vector或者指针。