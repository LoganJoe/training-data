---
title: " DTOJ3753Codec ID\t\t"
tags:
  - 点分治
url: 2417.html
id: 2417
categories:
  - DTOJ
  - Solution
date: 2018-06-14 22:29:41
---

先考虑没有加边怎么写。 这种路径问题很容易想到点分治。 通过重心将一条路径拆成两条，一条长度为$a$的路径和一条长度为$b$的路径通过重心连在一起的贡献是$131^x\\times 131^y$。那么对一条长度的为$a$路径，它和之前每条路径都会产生形如$131^z\\times k$的贡献，维护$\\sum k$即可。 这样如果没有加边，就可以在$\\Theta(n\\log \\space n)$解决问题。 再来考虑有加边的情况。据说很容易想到动态点分治，然而测试时的我并不会，然后我就开始瞎想。 新加一个点，答案会增加以这个点为一个端点的所有路径的贡献。也就是说，经过这个点的路径只会对之后的询问有贡献。 而且由于加边都是在原来的点的下面再挂一个点，所以一条路径每个点被加进来的时间从中点往两侧肯定是越来越晚的。因此我们可以根据这条路径两个端点被加入的时间来得知这条路径对哪个时间之后的询问有贡献。 我们预先加入所有的边，然后对之前的点分治进行一些魔改。 一条从重心到$x$的路径，$x$是在时间$t$被加入的。那么我们只考虑对$t$之后的询问的影响，因此我们要找的另一条路径要在$t$之前被加入。我们将之前直接维护贡献和，变成用树状数组维护每个时间点的贡献和，然后在树状数组上查询即可。 如果是按子树做的话要正反各做一次，或者求出所有贡献在减去子树的也行。 由于有个树状数组，时间复杂度$\\Theta(n\\log ^2 \\space n)$。 然后有一些奇奇怪怪的细节，比如说端点在重心的路径考虑飞了，两端时间相同和不同的路径被计算的次数不一样啊，慢慢调就可以了。 以下是吐槽。 我难得想出一个和大家好像都不同的写法，然而并没有A。 赛后发现我暴力怎么也WA了。 发现前几个询问都挺正常的，怎么第四个就凉了。 拍怎么还拍不出来。 是不是我想歪了啊。 诶我是不是$131$的幂预处理不够啊。 我预处理到$n+m$试试。 诶怎么变都没变啊。 气炸，怀疑人生。 过了1h……雾草这时候$m$是$0$啊！ 改完，A了。 我****************