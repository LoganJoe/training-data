---
title: " DTOJ3177影魔\t\t"
tags:
  - 线段树
url: 2656.html
id: 2656
categories:
  - DTOJ
  - Solution
date: 2018-07-03 20:51:34
---

题面真长… 简述一下，如果位置$l,r$分别是区间$\[l,r\]$的最大值和次大值，那么有$p1$的贡献；如果位置$l,r$一个是区间$\[l,r\]$的最大值，另一个不是次大值，那么有$p2$的贡献。 我们可以考虑枚举区间最大值所在的位置，然后研究一下哪些区间会带来什么贡献。 对于位置$i$，记左边第一个大于它的位置是$L\[i\]$，右边第一个大于它的位置是$R\[i\]$。 那么对于有第一类贡献的区间，其实上就是区间$\[L\[i\],R\[i\]\]$和区间$\[i,i+1\]$。 对于有第二类贡献的区间，其实上就是区间$\[L\[i\],i+1\],\[L\[i\],i+2\],…,\[L\[i\],R\[i\]-1\]$和区间$\[i-1,R\[i\]\],\[i-2,R\[i\]\],…,\[L\[i\]+1,R\[i\]\]$。 如果将区间对应到二维平面上的点，那么就有很多条线段（特殊地，我们认为一个点也是一个线段）提供对应的贡献，而查询是一个矩形。 注意到，横着的线段和竖着的线段其实是等价的，因此我们可以将所有线段都变成竖着的。 然后离线询问，扫描线+线段树维护区间加和区间查询即可。