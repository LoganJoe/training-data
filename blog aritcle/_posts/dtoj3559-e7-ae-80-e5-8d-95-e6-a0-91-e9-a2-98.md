---
title: " DTOJ3559简单树题\t\t"
tags:
  - 分块
  - 树形dp
url: 1077.html
id: 1077
categories:
  - DTOJ
  - Solution
date: 2018-03-18 21:45:14
---

考虑按标号分块。记$f\[i\]\[j\]$为第$i$块的点到$j$的距离和。现在考虑如何预处理和维护$f\[i\]\[j\]$。 先考虑预处理。显然从$1$dfs一遍我们可以求出$f\[i\]\[1\]$，考虑用类似树形dp的技巧，利用$f\[i\]\[1\]$求出剩下的$f\[i\]\[j\]$。也就是说，对于一个点$x$，我们知道了$f\[i\]\[x\]$，然后求出$x$的儿子$son$的$f\[i\]\[son\]$。 考虑$x\\rightarrow son$这条边带来的影响。首先以$son$为根的子树内第$i$块中的点不用走这条边到$x$了，走到$son$即可；然后第$i$块中的点除了在$son$子树内的，在走到$x$之后，还要走这条边到$son$。记$cnt\[i\]\[j\]$为以$j$为根的子树内有多少个第$i$块的点，那我们就可以通过$f\[i\]\[x\],cnt\[i\]\[son\],cnt\[i\]\[1\]$来求出$f\[i\]\[son\]$。 修改也是同理。假设修改的边是$x\\rightarrow son$，边权的改变量是$v$。那么以$son$为根的子树内每一块的点，到子树外每个点的距离和都改变了$v$，可以通过$cnt\[i\]\[son\]$算出；同样地，子树外每一块的点，到子树内每个点的距离和也改变了$v$，也可以通过$cnt\[i\]\[1\],cnt\[i\]\[son\]$算出。由于这些都是区间修改，而且涉及子树，因此$f\[i\]\[j\]$中的$j$要按dfs序用树状数组维护，也就是对于每一块开一个树状数组。 对于查询标号在$\[L,R\]$中的点到$x$的距离和。显然$\[L,R\]$内的整块可以直接用$f\[i\]\[x\]$得到，对于两边不完整的块，我们暴力求每个点到$x$的距离，也就是$deep\_x+deep\_y-2deep_{lca}$，只要再用一个树状数组维护$deep$即可。