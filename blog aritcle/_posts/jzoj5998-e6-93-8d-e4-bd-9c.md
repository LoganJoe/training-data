---
title: " JZOJ5998操作\t\t"
tags:
  - 分治
  - 多项式
url: 6029.html
id: 6029
categories:
  - Solution
date: 2019-01-15 19:49:28
---

![](http://www.dtenomde.com/wp-content/uploads/2019/01/-e1547551696487.png) 我们将每次操作看做将$x$套进一个一次函数$f(x)=kx+b$。将$x$放在期望下面考虑，那么对$E(x)$，将其做$i$操作，其贡献即是$E(f(x))=\[p\_i+(1-p\_i)\\times B\_i\]x+p\_i \\times A\_i$。 我们要考虑计算某个操作作为$+$操作时，在其后面的$\\times$操作的贡献。注意到这里我们要对于每种排列都计算一次，所以要将在其后面出现所有$\\times$的贡献都算出来。 这个东西即是将除该操作外其他所有操作对应的多项式$f\_i(x)=1+\[p\_i+(1-p\_i)\\times B\_i\]x$都卷积起来，其得到的多项式$D(x)$的第$x^k$项即是在后面出现$k$个$\\times$操作的贡献和。考虑这些数放在后面位置可以互换，其他非贡献操作位置也可以互换；那么$A\_mp\_m\[x^k\]D\_m(x) \\times k! \\times (n-k-1)!$即是对于第$m$个操作的贡献和。 最后的答案，显然是对于每个$D\_m(x)$都要算一次答案。这样效率就是$O(n^2\\log^2 n)$的了。其中，$D\_m(x)$可以用分治NTT处理。 接下来考虑优化。 注意到，我们并不关心所缺的一个操作是哪一个操作。因此，我们分治的时候，可以直接分治求出$F_{l,r}(x)$为$\[l:r\]$中缺一个操作的$D_(x)$和。具体来说，分治的时候同时传两个多项式$f(x),g(x)$，其中$f(x)$为缺一个操作的多项式，$g(x)$为这边的$A\_ip\_i$卷积。然后拿左边的$f(x)$卷右边的$g(x)$，另外一种情况同理。而$g(x)$直接从两边的$g(x)$更新上来，这样就可以分治出所有的多项式乘$A\_ip\_i$再求和的结果了。 时间复杂度$O(n \\log^2 n)$。