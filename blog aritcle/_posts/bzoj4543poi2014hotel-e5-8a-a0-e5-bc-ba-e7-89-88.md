---
title: " BZOJ4543[POI2014]Hotel加强版\t\t"
tags:
  - 树形dp
  - 树链剖分
url: 948.html
id: 948
categories:
  - BZOJ
  - Solution
date: 2018-03-06 07:46:16
---

神仙题。 考虑树形dp。 令$f\[i\]\[j\]$表示以$i$为根的子树内，与$i$距离为$j$的点个数。$g\[i\]\[j\]$表示有多少点对满足它们到$lca$的距离为$d$，且$lca$到$i$的距离为$d-j$，即若第三个点不在以$i$为根的子树内且与$i$距离为$j$能与$g\[i\]\[j\]$这么多的点对构成合法解。 考虑转移。 记$x$的儿子为$to$。于是我们有

$$f\[x\]\[i\]=\\sum_{x\\rightarrow to}f\[to\]\[i-1\]$$

$$g\[x\]\[i\]=\\sum_{x\\rightarrow to}g\[to\]\[i+1\]+\\sum_{x\\rightarrow to}f\[x\]\[i\]\\times f\[to\]\[i-1\]$$

转移$g$的后半部分就是把$x$当作点对的$lca$统计点对个数。 考虑答案的统计。 首先是$x$是三个点中的某个点，因此$ans=\\sum_{x=1}^{n}{g\[x\]\[0\]}$。同时在转移的过程中，可以统计出三个点至少有一个但不是全部在这个新儿子子树里的答案个数。即

$f\[x\]\[i-1\]\\times g\[to\]\[i\]+g\[x\]\[i+1\]\\times f\[to\]\[i\]$

要注意转移和统计答案的顺序。 这种朴素dp是$n^2$的，考虑优化。 我们对树进行长链剖分，每次转移优先转移重儿子。 如果先转移重儿子的话，我们发现每次都是$f\[x\]\[i\]=f\[to\]\[i-1\]$，$g\[x\]\[i\]=g\[to\]\[i+1\]$，相当于将数组右移一位，可以用指针O($1$)实现。看到有dalao手写链表，代码太复杂了，学不来。 那只剩下对轻儿子的转移。 记以$i$为根的子树的深度为$Maxd\[i\]$，那么对一个轻儿子的转移是O($Maxd\[i\]$)的。容易知道以$i$为根的子树内深度最深的一定是一个叶结点，也就是以轻儿子为起点的长链的终点。 那么转移的总复杂度就是长链长度和，也就是O($n$)。 那么空间复杂度也是O($n$)，用指针动态分配内存即可。 $f$是不断左移，分配$Maxd\[i\]$的空间。$g$是不断右移，需要$2Maxd\[i\]$的空间。 get指针黑科技。